<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Chained Chaos - Prototype</title>
    <style>
        body {
            margin: 0;
            background-color: #222;
            color: white;
            font-family: 'Courier New', Courier, monospace;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            overflow: hidden;
        }
        canvas {
            background-color: #f0f0f0;
            border: 4px solid #444;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }
        #ui {
            margin-bottom: 10px;
            text-align: center;
        }
        .controls {
            font-size: 12px;
            color: #aaa;
            margin-top: 5px;
        }
    </style>
</head>
<body>

    <div id="ui">
        <h1>CHAINED CHAOS</h1>
        <div id="status">Raggiungete la zona VERDE insieme!</div>
        <div class="controls">P1: WASD | P2: FRECCE | R: Riavvia</div>
    </div>

    <canvas id="gameCanvas" width="800" height="500"></canvas>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');

    // --- CONFIGURAZIONE GIOCO ---
    const GRAVITY = 0.5;
    const JUMP_FORCE = -10;
    const SPEED = 5;
    const FRICTION = 0.8;
    const ROPE_LENGTH = 150; // Lunghezza massima della corda
    const ROPE_STRENGTH = 0.05; // Quanto è forte l'elastico

    // --- INPUT ---
    const keys = {};
    window.addEventListener('keydown', e => keys[e.code] = true);
    window.addEventListener('keyup', e => keys[e.code] = false);

    // --- CLASSI ---
    class Player {
        constructor(x, y, color, controls) {
            this.x = x;
            this.y = y;
            this.w = 30;
            this.h = 30;
            this.vx = 0;
            this.vy = 0;
            this.color = color;
            this.controls = controls; // {up, left, right}
            this.grounded = false;
        }

        update() {
            // Controlli
            if (keys[this.controls.left]) this.vx -= 1;
            if (keys[this.controls.right]) this.vx += 1;
            if (keys[this.controls.up] && this.grounded) {
                this.vy = JUMP_FORCE;
                this.grounded = false;
            }

            // Fisica
            this.vy += GRAVITY;
            this.vx *= FRICTION;

            this.x += this.vx;
            this.y += this.vy;

            // Limiti Canvas (Muri laterali)
            if (this.x < 0) { this.x = 0; this.vx = 0; }
            if (this.x + this.w > canvas.width) { this.x = canvas.width - this.w; this.vx = 0; }
            
            // Morte (Caduta)
            if (this.y > canvas.height) {
                resetGame("GAME OVER! Qualcuno è caduto.");
            }
        }

        draw() {
            ctx.fillStyle = this.color;
            ctx.fillRect(this.x, this.y, this.w, this.h);
        }
    }

    class Platform {
        constructor(x, y, w, h, isGoal = false) {
            this.x = x;
            this.y = y;
            this.w = w;
            this.h = h;
            this.isGoal = isGoal;
        }

        draw() {
            ctx.fillStyle = this.isGoal ? '#4cd137' : '#2f3640';
            ctx.fillRect(this.x, this.y, this.w, this.h);
        }
    }

    // --- INIZIALIZZAZIONE ---
    let p1, p2, platforms;

    function init() {
        // Posizioni iniziali
        p1 = new Player(50, 300, '#e84118', {up: 'KeyW', left: 'KeyA', right: 'KeyD'}); // Rosso
        p2 = new Player(100, 300, '#0097e6', {up: 'ArrowUp', left: 'ArrowLeft', right: 'ArrowRight'}); // Blu

        // Creazione Livello
        platforms = [
            new Platform(0, 400, 200, 20),   // Start
            new Platform(250, 350, 100, 20), // Salto 1
            new Platform(400, 250, 100, 20), // Salto 2
            new Platform(550, 300, 80, 20),  // Salto 3
            new Platform(680, 200, 120, 20, true) // Arrivo (Verde)
        ];
    }

    // --- FISICA CORDA (IL CUORE DEL GIOCO) ---
    function updateRope() {
        const dx = p2.x - p1.x;
        const dy = p2.y - p1.y;
        const distance = Math.sqrt(dx * dx + dy * dy);

        if (distance > ROPE_LENGTH) {
            const force = (distance - ROPE_LENGTH) * ROPE_STRENGTH;
            const angle = Math.atan2(dy, dx);
            
            const fx = Math.cos(angle) * force;
            const fy = Math.sin(angle) * force;

            // Applica forza ai giocatori (tira l'uno verso l'altro)
            p1.vx += fx;
            p1.vy += fy;
            p2.vx -= fx;
            p2.vy -= fy;
        }
    }

    function checkCollisions(player) {
        player.grounded = false;
        platforms.forEach(plat => {
            // Collisione semplice AABB
            if (player.x < plat.x + plat.w &&
                player.x + player.w > plat.x &&
                player.y < plat.y + plat.h &&
                player.y + player.h > plat.y) {
                
                // Controllo vittoria
                if (plat.isGoal) {
                    // Controlliamo se entrambi sono sulla piattaforma finale
                    if (p1.x > 680 && p2.x > 680) {
                        document.getElementById('status').innerText = "VITTORIA! Premete R per ricominciare";
                        document.getElementById('status').style.color = "#4cd137";
                    }
                }

                // Risoluzione collisione (atterraggio)
                // Controlla se il giocatore stava cadendo VERSO la piattaforma
                if (player.vy > 0 && player.y + player.h - player.vy <= plat.y) {
                    player.grounded = true;
                    player.vy = 0;
                    player.y = plat.y - player.h;
                }
            }
        });
    }

    function drawRope() {
        ctx.beginPath();
        ctx.moveTo(p1.x + p1.w/2, p1.y + p1.h/2);
        ctx.lineTo(p2.x + p2.w/2, p2.y + p2.h/2);
        
        // Colore corda cambia in base alla tensione
        const dx = p2.x - p1.x;
        const dy = p2.y - p1.y;
        const dist = Math.sqrt(dx*dx + dy*dy);
        
        ctx.strokeStyle = dist > ROPE_LENGTH ? '#e74c3c' : '#353b48';
        ctx.lineWidth = dist > ROPE_LENGTH ? 4 : 2;
        ctx.stroke();
    }

    function resetGame(msg) {
        if(msg) document.getElementById('status').innerText = msg;
        init();
    }

    // --- GAME LOOP ---
    function loop() {
        // Pulisci schermo
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        if (keys['KeyR']) {
            resetGame("Raggiungete la zona VERDE insieme!");
        }

        // Aggiorna Giocatori
        p1.update();
        p2.update();

        // Fisica Corda
        updateRope();

        // Collisioni
        checkCollisions(p1);
        checkCollisions(p2);

        // Disegna tutto
        platforms.forEach(p => p.draw());
        drawRope();
        p1.draw();
        p2.draw();

        requestAnimationFrame(loop);
    }

    init();
    loop();

</script>
</body>
</html>
